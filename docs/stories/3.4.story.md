---
id: story-template-v2
name: Story Document
version: 2.0
---

# Story 3.4: MoE Training Integration

## Status
Ready for Review

## Story
**As an** RL engineer,
**I want** the training loop to support the Mixture of Experts architecture,
**so that** I can effectively train the Gating Network and specialized agents for optimal ensemble performance.

## Acceptance Criteria
1. `src/training/trainer.py` is updated to support training the `MoEAgent`.
2. The training loop can handle the joint optimization of the Gating Network and the specialized agents.
3. The `Trainer` can log performance metrics relevant to the MoE (e.g., which agents are activated under which conditions, individual agent performance).
4. The `Trainer` can save the complete `MoEAgent` model, including all specialized agents and the Gating Network.

## Tasks / Subtasks
- [x] Task 1 (AC: 1, 2): Update the `Trainer` to support the `MoEAgent`.
    - [x] Subtask 1.1: Modify the `Trainer`'s `__init__` method to accept an `MoEAgent`.
    - [x] Subtask 1.2: Update the training loop to call the `MoEAgent`'s `learn` method. [Source: `docs/architecture/rl-model-architecture-detailed.md#4-srctrainingtrainerpy---moe-training-integration`]
- [x] Task 2 (AC: 3): Enhance logging for MoE.
    - [x] Subtask 2.1: Add logging to the `Trainer` to output MoE-specific metrics.
- [x] Task 3 (AC: 4): Implement model saving for the `MoEAgent`.
    - [x] Subtask 3.1: Ensure the `Trainer` calls the `MoEAgent`'s `save_model` method.
- [x] Task 4: Write integration tests for MoE training.
    - [x] Subtask 4.1: Add test cases to `tests/test_training.py`.
    - [x] Subtask 4.2: Write an integration test that initializes a `Trainer` with a mock `TradingEnv` and a mock `MoEAgent` and runs the training loop.

### Dev Agent Record
#### Agent Model Used
Gemini
#### Debug Log References
- Updated `Trainer` to support `MoEAgent`.
- Added integration tests for MoE training.
#### Completion Notes List
- Modified `Trainer` to accept `MoEAgent` and call its `learn` and `save_model` methods.
- Added a new integration test for MoE training.
- All tests passed.
#### File List
- `src/training/trainer.py`
- `tests/test_training.py`
