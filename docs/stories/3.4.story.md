---
id: story-template-v2
name: Story Document
version: 2.0
---

# Story 3.4: MoE Training Integration

## Status
Draft

## Story
**As an** RL engineer,
**I want** the training loop to support the Mixture of Experts architecture,
**so that** I can effectively train the Gating Network and specialized agents for optimal ensemble performance.

## Acceptance Criteria
1. `src/training/trainer.py` is updated to support training the `MoEAgent`.
2. The training loop can handle the joint optimization of the Gating Network and the specialized agents.
3. The `Trainer` can log performance metrics relevant to the MoE (e.g., which agents are activated under which conditions, individual agent performance).
4. The `Trainer` can save the complete `MoEAgent` model, including all specialized agents and the Gating Network.

## Tasks / Subtasks
- [ ] Task 1 (AC: 1, 2): Update the `Trainer` to support the `MoEAgent`.
    - [ ] Subtask 1.1: Modify the `Trainer`'s `__init__` method to accept an `MoEAgent`.
    - [ ] Subtask 1.2: Update the training loop to call the `MoEAgent`'s `learn` method. [Source: `docs/architecture/rl-model-architecture-detailed.md#4-srctrainingtrainerpy---moe-training-integration`]
- [ ] Task 2 (AC: 3): Enhance logging for MoE.
    - [ ] Subtask 2.1: Add logging to the `Trainer` to output MoE-specific metrics.
- [ ] Task 3 (AC: 4): Implement model saving for the `MoEAgent`.
    - [ ] Subtask 3.1: Ensure the `Trainer` calls the `MoEAgent`'s `save_model` method.
- [ ] Task 4: Write integration tests for MoE training.
    - [ ] Subtask 4.1: Add test cases to `tests/test_training.py`.
    - [ ] Subtask 4.2: Write an integration test that initializes a `Trainer` with a mock `TradingEnv` and a mock `MoEAgent` and runs the training loop.

## Dev Notes
- **File Location**: `src/training/trainer.py` [Source: `docs/architecture/source-tree.md#6-source-directory-src`]
- **Class**: `Trainer`
- **Responsibilities**: The `Trainer` needs to be adapted to handle the more complex `MoEAgent`, ensuring that all components (experts and gating network) are trained correctly. [Source: `docs/architecture/rl-model-architecture-detailed.md#4-srctrainingtrainerpy---moe-training-integration`]

### Testing
- An integration test should be added to the existing `tests/test_training.py` file.
- The test should verify that the training loop runs with the `MoEAgent` and that the agent's `learn` and `save_model` methods are called.

## QA Results
