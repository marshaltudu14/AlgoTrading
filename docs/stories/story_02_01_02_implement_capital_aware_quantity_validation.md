---

### **Story 2.1.2: Implement Capital-Aware Quantity Validation**

**Status:** `Completed`

**Story:**
As a developer, I need to validate the quantity predicted by the model against the user's available capital, so that the system does not attempt to place trades that would be rejected due to insufficient funds.

**Acceptance Criteria:**
1.  After a quantity is generated by the model, the `LiveTradingService` calls the `CapitalAwareQuantity` class from `src/utils/capital_aware_quantity.py`.
2.  The `LiveTradingService` provides the user's current available capital (fetched from the Fyers API) and the instrument's current price to the `CapitalAwareQuantity` class.
3.  The `adjust_quantity_for_capital` method is used to determine the maximum allowable quantity for the trade.
4.  The final trade quantity is the lesser of the model's predicted quantity and the maximum allowable quantity.
5.  If the model's predicted quantity is greater than zero but the maximum allowable quantity is zero, the trade is not placed.
6.  The system logs both the original predicted quantity and the final, adjusted quantity.

**Tasks / Subtasks:**
-   `[x]` **Backend:** In `src/trading/live_trading_service.py`, after the model generates a signal and quantity, add a call to fetch the user's current funds using the `FyersClient`.
-   `[x]` **Backend:** Instantiate the `CapitalAwareQuantity` class.
-   `[x]` **Backend:** Call the `adjust_quantity_for_capital` method, passing the necessary parameters.
-   `[x]` **Backend:** Implement the logic to compare the predicted quantity with the adjusted quantity and use the smaller value.
-   `[x]` **Backend:** Add a condition to prevent placing a trade if the final quantity is zero.
-   `[x]` **Backend:** Add detailed logging for this validation step.
-   `[ ]` **Testing:** In `tests/test_trading/`, add a new test file `test_capital_aware_integration.py`.
-   `[ ]` **Testing:** Write a unit test that simulates a model prediction and verifies that the `adjust_quantity_for_capital` method is called with the correct parameters.
-   `[ ]` **Testing:** Write a test where the predicted quantity is higher than the allowable quantity and assert that the final quantity is correctly adjusted downwards.
-   `[ ]` **Testing:** Write a test where the user has insufficient capital and assert that the final quantity is zero and no trade is placed.

---