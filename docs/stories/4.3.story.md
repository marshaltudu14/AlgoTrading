---
id: story-template-v2
name: Story Document
version: 2.0
---

# Story 4.3: Outer Loop (Meta-Update) Implementation

## Status
Draft

## Story
**As an** RL engineer,
**I want** to implement the outer loop of the MAML algorithm,
**so that** the meta-learner can update the agent's initial parameters based on performance across adapted tasks.

## Acceptance Criteria
1. `src/training/trainer.py` is updated to manage the MAML outer loop.
2. After performing inner-loop adaptations for a batch of tasks, the `Trainer` calculates a meta-loss based on the performance of the adapted policies on new data from those tasks.
3. The `Trainer` then updates the agent's global (meta) parameters using this meta-loss, aiming for an initialization that facilitates rapid learning on new, unseen tasks.
4. The meta-update process correctly propagates gradients through the inner-loop computations.

## Tasks / Subtasks
- [ ] Task 1 (AC: 1, 2, 3, 4): Implement the outer loop meta-update.
    - [ ] Subtask 1.1: Enhance the `Trainer` to manage the MAML outer loop.
    - [ ] Subtask 1.2: Implement the logic to calculate the meta-loss.
    - [ ] Subtask 1.3: Implement the logic to update the agent's global parameters. [Source: `docs/architecture/rl-model-architecture-detailed.md#3-srctrainingtrainerpy---outer-loop-meta-update-implementation`]
- [ ] Task 2: Write integration tests for the outer loop.
    - [ ] Subtask 2.1: Add test cases to `tests/test_training.py`.
    - [ ] Subtask 2.2: Write an integration test that runs the full MAML training loop for a small number of iterations and verifies that the agent's meta-parameters are updated.

## Dev Notes
- **File Location**: `src/training/trainer.py` [Source: `docs/architecture/source-tree.md#6-source-directory-src`]
- **Responsibilities**: This is the second core part of the MAML algorithm, where the agent learns a good initialization for fast adaptation. [Source: `docs/architecture/rl-model-architecture-detailed.md#3-srctrainingtrainerpy---outer-loop-meta-update-implementation`]

### Testing
- An integration test should be added to the existing `tests/test_training.py` file.

## QA Results
