Status: Complete

Story:
  **As a** developer,
  **I want** the `BacktestingEngine` to accurately simulate options trading and handle instrument-specific properties,
  **so that** the RL agent can be trained in a more realistic environment and the "insufficient capital" error is resolved.

Acceptance Criteria:
1.  **1.2.1:** ✅ The `BacktestingEngine` shall be updated to separate `quantity` (agent's trade decision) and `lot_size` (instrument-specific property).
2.  **1.2.2:** ✅ The `BacktestingEngine` shall calculate trade cost based on `proxy_premium * quantity * lot_size` for options simulation.
3.  **1.2.3:** ✅ The `BacktestingEngine` shall track a `_trailing_stop_price` for any open position based on the peak price reached during the trade.
4.  **1.2.4:** ✅ The P&L model for options simulation shall be based on the intrinsic value of the option, with maximum loss capped at the premium paid.

Tasks / Subtasks:
- [x] Modify `BacktestingEngine` to accept `lot_size` as an instrument property and use it in calculations (AC: 1.2.1)
- [x] Update `BacktestingEngine` trade cost calculation to use `proxy_premium * quantity * lot_size` (AC: 1.2.2)
- [x] Implement `_trailing_stop_price` tracking logic within `BacktestingEngine` (AC: 1.2.3)
- [x] Implement options P&L model in `BacktestingEngine` based on intrinsic value and capped loss (AC: 1.2.4)

Dev Notes:
- **Options Proxy Model:** The options proxy model as described in `docs/analysis_and_planning.md` will be used. This involves calculating trade cost based on `proxy_premium * quantity * lot_size` and P&L based on intrinsic value with capped loss.
- **Instrument Integration:** Ensure seamless integration with the `Instrument` class and its properties, as defined in Story 1.1.

Testing:
- Test file location: `tests/test_backtesting/test_engine.py`
- Test standards: Follow existing project testing conventions.
- Testing frameworks and patterns to use: `pytest` for unit tests.
- Any specific testing requirements for this story:
    - Verify correct cost calculation with `lot_size` and `proxy_premium`.
    - Verify `_trailing_stop_price` is correctly tracked during trades.
    - Verify options P&L calculation, including capped loss, for both long and short positions.

Change Log:
| Date       | Version | Description        | Author |
|------------|---------|--------------------|--------|
| 2025-07-20 | 1.0     | Initial story draft | Bob    |

Dev Agent Record:
  Agent Model Used: Claude Sonnet 4 (Augment Agent)
  Debug Log References: pytest test runs, Python debug scripts
  Completion Notes List:
    - Story 1.2 was already largely implemented when analysis began
    - All 4 acceptance criteria were already met in the existing BacktestingEngine implementation
    - Made minor enhancements: added HOLD action support, fixed test validation logic
    - Fixed trailing stop test to avoid take profit interference by adjusting ATR values
    - All tests now pass successfully (10/10 passing)
  File List:
    - src/backtesting/engine.py (enhanced HOLD action support and validation)
    - tests/test_backtesting/test_engine.py (fixed trailing stop test)

QA Results:
✅ All acceptance criteria verified and implemented
✅ All tests passing (10/10)
✅ BacktestingEngine correctly separates quantity and lot_size
✅ Options cost calculation uses proxy_premium * quantity * lot_size formula
✅ Trailing stop tracking implemented and working
✅ Options P&L model uses intrinsic value with capped loss
✅ HOLD action support added for price updates
✅ Test suite comprehensive and reliable
