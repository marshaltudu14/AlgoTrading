---
id: story-template-v2
name: Story Document
version: 2.0
---

# Story 3.3: MoE Agent & Consensus System

## Status
Draft

## Story
**As an** RL engineer,
**I want** a Mixture of Experts (MoE) agent that combines recommendations from specialized agents,
**so that** the system can make a unified trading decision based on the perceived market regime.

## Acceptance Criteria
1. `src/agents/moe_agent.py` contains a class `MoEAgent` that inherits from `BaseAgent`.
2. `MoEAgent` initializes with instances of the specialized agents (from Story 3.1) and the Gating Network (from Story 3.2).
3. The `select_action` method in `MoEAgent` uses the Gating Network to get weights, then combines the actions/recommendations of the specialized agents based on these weights to produce a single, final trading action.
4. The `learn` method in `MoEAgent` orchestrates the learning for both the specialized agents and the Gating Network, potentially using a joint optimization strategy.
5. The `MoEAgent` can be instantiated and interact with the `TradingEnv`.

## Tasks / Subtasks
- [ ] Task 1 (AC: 1, 2): Implement the `MoEAgent` class structure.
    - [ ] Subtask 1.1: In `src/agents/moe_agent.py`, define the `MoEAgent` class, inheriting from `BaseAgent`.
    - [ ] Subtask 1.2: Implement the `__init__` method to accept a list of expert agents and a gating network. [Source: `docs/architecture/rl-model-architecture-detailed.md#3-srcagentsmoe_agentpy---moe-agent--consensus-system`]
- [ ] Task 2 (AC: 3): Implement the `select_action` method.
    - [ ] Subtask 2.1: Implement the `select_action` method to get weights from the gating network and combine the expert recommendations.
- [ ] Task 3 (AC: 4): Implement the `learn` method.
    - [ ] Subtask 3.1: Implement a placeholder `learn` method that calls the `learn` method of each expert and the gating network.
- [ ] Task 4 (AC: 5): Write unit tests for the `MoEAgent`.
    - [ ] Subtask 4.1: Add test cases to `tests/test_agents.py`.
    - [ ] Subtask 4.2: Write a test case to verify that the agent can be initialized correctly.
    - [ ] Subtask 4.3: Write a test case to ensure `select_action` returns a valid action.

## Dev Notes
- **File Location**: `src/agents/moe_agent.py` [Source: `docs/architecture/source-tree.md#6-source-directory-src`]
- **Class**: `MoEAgent`
- **Base Class**: `BaseAgent`
- **Responsibilities**: This class is the coordinator for the MoE framework. It is responsible for getting recommendations from the experts and combining them into a single action. [Source: `docs/architecture/rl-model-architecture-detailed.md#3-srcagentsmoe_agentpy---moe-agent--consensus-system`]

### Testing
- Unit tests should be added to the existing `tests/test_agents.py` file.
- Tests should mock the specialized agents and the gating network to focus on the `MoEAgent`'s logic.

## QA Results
