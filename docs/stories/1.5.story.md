---
id: story-template-v2
name: Story Document
version: 2.0
---

# Story 1.5: Backtesting Environment (src/backtesting/environment.py)

## Status
Ready for Review

## Story
**As an** RL engineer,
**I want** an RL environment that interfaces with the backtesting engine,
**so that** I can train and evaluate RL agents.

## Acceptance Criteria
1. `src/backtesting/environment.py` contains a class `TradingEnv` that inherits from a suitable RL environment base class (e.g., OpenAI Gym's `gym.Env`).
2. `TradingEnv` can be initialized with a dataset (loaded via `DataLoader` from `data/raw`).
3. The `step(action)` method:
    - Translates an RL agent's discrete action (`BUY_LONG`, `SELL_SHORT`, `CLOSE_LONG`, `CLOSE_SHORT`, `HOLD`) into `BacktestingEngine` calls.
    - Calculates and returns a reward signal based on the change in portfolio value (P&L) per step, after accounting for transaction costs.
    - Applies penalties for invalid actions (e.g., trying to sell when no position, or buying with insufficient capital).
    - Returns the next observation, reward, `done` flag, and `info` dictionary.
4. The `reset()` method resets the environment to an initial state, returning the initial observation.
5. The observation space includes: OHLCV data for the current step, current capital, current position, and unrealized P&L.
6. All components of the observation space are normalized (e.g., using Z-score scaling).

## Tasks / Subtasks
- [x] Task 1 (AC: 1): Implement the `TradingEnv` class structure.
    - [x] Subtask 1.1: Create the file `src/backtesting/environment.py`.
    - [x] Subtask 1.2: Define the `TradingEnv` class, inheriting from `gym.Env`. [Source: `docs/architecture/rl-model-architecture-detailed.md#3-srcbacktestingenvironmentpy---trading-environment`]
    - [x] Subtask 1.3: Implement the `__init__` method to accept a `DataLoader`, `symbol`, `initial_capital`, and `lookback_window`. It should initialize the `BacktestingEngine` and define the `observation_space` and `action_space` using `gym.spaces`.
- [x] Task 2 (AC: 4): Implement the `reset` method.
    - [x] Subtask 2.1: Implement the `reset()` method to load the data for the specified symbol using the `DataLoader`, reset the `BacktestingEngine`, and return the initial observation.
- [x] Task 3 (AC: 3, 5, 6): Implement the `step` method.
    - [x] Subtask 3.1: Implement the logic to map the discrete action from the agent to the corresponding trade execution in the `BacktestingEngine`.
    - [x] Subtask 3.2: Implement the reward calculation logic, which should be based on the change in P&L. Include penalties for invalid actions.
    - [x] Subtask 3.3: Implement the `_get_observation` helper method to construct the observation for the current step, including market data and normalized account state.
- [x] Task 4: Write unit tests for the `TradingEnv`.
    - [x] Subtask 4.1: Add test cases to `tests/test_backtesting.py`.
    - [x] Subtask 4.2: Write a test case to verify correct initialization of the environment, including observation and action spaces.
    - [x] Subtask 4.3: Write a test case for the `reset` method, ensuring it returns a valid initial observation.
    - [x] Subtask 4.4: Write test cases for the `step` method, covering valid and invalid actions and verifying the returned observation, reward, and done flag.

## Dev Notes
- **File Location**: `src/backtesting/environment.py` [Source: `docs/architecture/source-tree.md#6-source-directory-src`]
- **Class**: `TradingEnv`
- **Base Class**: `gym.Env`
- **Responsibilities**: This class is the bridge between the RL agent and the financial simulation. It provides the agent with a view of the world (observation), allows the agent to act (action), and gives feedback on those actions (reward). [Source: `docs/architecture/rl-model-architecture-detailed.md#3-srcbacktestingenvironmentpy---trading-environment`]
- **Observation Space**: The observation should be a normalized `gym.spaces.Box` containing a lookback window of market data and the current account state from the `BacktestingEngine`.
- **Action Space**: The action space should be a `gym.spaces.Discrete(5)` corresponding to the five trading actions.

### Testing
- Unit tests should be added to the existing `tests/test_backtesting.py` file.
- Tests should mock the `DataLoader` and `BacktestingEngine` to isolate the `TradingEnv` logic.

## QA Results
