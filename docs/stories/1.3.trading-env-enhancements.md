Status: Draft

Story:
  **As a** developer,
  **I want** the `TradingEnv` to provide a more realistic and effective training environment for RL agents,
  **so that** the agents can learn more sophisticated trading strategies and risk management.

Acceptance Criteria:
1.  **1.3.1:** The `TradingEnv` shall calculate and pass a `proxy_premium` for each trade to the `BacktestingEngine`.
2.  **1.3.2:** The `TradingEnv` shall incorporate trading `quantity` as part of the action space, allowing the agent to learn position sizing.
3.  **1.3.3:** The `TradingEnv` shall support sophisticated reward functions beyond simple P&L (e.g., Sharpe Ratio, Sortino Ratio, Profit Factor).
4.  **1.3.4:** The `TradingEnv` shall use reward shaping to guide agent behavior (e.g., penalty for idleness, bonus for realizing profits, penalty for over-trading).
5.  **1.3.5:** The `TradingEnv` shall use z-score normalization for the observation space.
6.  **1.3.6:** The `TradingEnv` shall terminate an episode prematurely if the account's drawdown exceeds a predefined limit (e.g., 20%).
7.  **1.3.7:** The `TradingEnv` shall terminate an episode prematurely if the remaining capital is insufficient to place a new trade.
8.  **1.3.8:** The `TradingEnv` shall add the normalized `distance_to_trail` to the agent's observation space.
9.  **1.3.9:** The `TradingEnv` shall provide reward shaping for trailing stops (bonus for holding a profitable position as the trailing stop improves, penalty for closing a profitable position prematurely when the trend is still strong).

Tasks / Subtasks:
- [ ] Implement `proxy_premium` calculation in `TradingEnv` and pass to `BacktestingEngine` (AC: 1.3.1)
- [ ] Modify `TradingEnv` action space to include trading `quantity` (AC: 1.3.2)
- [ ] Implement support for configurable sophisticated reward functions (AC: 1.3.3)
- [ ] Implement reward shaping mechanisms (AC: 1.3.4)
- [ ] Implement z-score normalization for `TradingEnv` observation space (AC: 1.3.5)
- [ ] Add episode termination condition for maximum drawdown (AC: 1.3.6)
- [ ] Add episode termination condition for insufficient capital (AC: 1.3.7)
- [ ] Add normalized `distance_to_trail` to `TradingEnv` observation space (AC: 1.3.8)
- [ ] Implement reward shaping for trailing stops (AC: 1.3.9)

Dev Notes:
- **Instrument Integration:** Ensure seamless integration with the `Instrument` class and its properties, as defined in Story 1.1.
- **BacktestingEngine Integration:** Ensure proper interaction with the enhanced `BacktestingEngine` from Story 1.2.

Testing:
- Test file location: `tests/test_backtesting/test_environment.py`
- Test standards: Follow existing project testing conventions.
- Testing frameworks and patterns to use: `pytest` for unit tests.
- Any specific testing requirements for this story:
    - Verify `proxy_premium` calculation and passing.
    - Verify dynamic action space for `quantity`.
    - Verify new reward functions and shaping mechanisms.
    - Verify z-score normalization of observation space.
    - Verify episode termination conditions for drawdown and insufficient capital.
    - Verify `distance_to_trail` is correctly added to observation space.
    - Verify reward shaping for trailing stops.

Change Log:
| Date       | Version | Description        | Author |
|------------|---------|--------------------|--------|
| 2025-07-20 | 1.0     | Initial story draft | Bob    |

Dev Agent Record:
  Agent Model Used:
  Debug Log References:
  Completion Notes List:
  File List:

QA Results:
