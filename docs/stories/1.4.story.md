---
id: story-template-v2
name: Story Document
version: 2.0
---

# Story 1.4: Basic Backtesting Engine (src/backtesting/engine.py)

## Status
Ready for Review

## Story
**As an** RL engineer,
**I want** a core backtesting engine that simulates trading mechanics,
**so that** I can accurately evaluate the RL agent's performance.

## Acceptance Criteria
1. `src/backtesting/engine.py` contains a class `BacktestingEngine`.
2. `BacktestingEngine` can be initialized with a starting capital.
3. It supports `execute_trade(action, price, quantity)` method that updates internal capital and position.
4. It accurately tracks current capital, open positions (symbol, quantity, entry price), and unrealized/realized P&L.
5. Fixed brokerage costs (25 INR entry, 35 INR exit) are applied to each trade.
6. Negligible slippage is simulated (e.g., by executing at the provided `price` without modification).
7. It provides methods to retrieve current capital, position, and P&L.

## Tasks / Subtasks
- [x] Task 1 (AC: 1, 2): Implement the `BacktestingEngine` class structure.
    - [x] Subtask 1.1: Create the file `src/backtesting/engine.py`.
    - [x] Subtask 1.2: Define the `BacktestingEngine` class with an `__init__` method that accepts `initial_capital` and initializes account variables (capital, position, P&L). [Source: `docs/architecture/rl-model-architecture-detailed.md#2-srcbacktestingenginepy---backtesting-engine`]
- [x] Task 2 (AC: 3, 4, 5, 6): Implement the `execute_trade` method.
    - [x] Subtask 2.1: Implement logic to handle `BUY_LONG` and `SELL_SHORT` actions, updating the current position and deducting capital.
    - [x] Subtask 2.2: Implement logic to handle `CLOSE_LONG` and `CLOSE_SHORT` actions, calculating realized P&L and updating capital.
    - [x] Subtask 2.3: Apply a fixed brokerage cost of 25 INR for entry trades and 35 INR for exit trades.
    - [x] Subtask 2.4: Calculate and update unrealized P&L based on the current price and open position.
- [x] Task 3 (AC: 7): Implement getter methods.
    - [x] Subtask 3.1: Create a method `get_account_state()` that returns a dictionary containing `capital`, `position`, `realized_pnl`, and `unrealized_pnl`. [Source: `docs/architecture/rl-model-architecture-detailed.md#2-srcbacktestingenginepy---backtesting-engine`]
- [x] Task 4: Implement a `reset` method.
    - [x] Subtask 4.1: Create a `reset()` method that restores the engine to its initial state (initial capital, no positions, zero P&L).
- [x] Task 5: Write unit tests for the `BacktestingEngine`.
    - [x] Subtask 5.1: Create a test file `tests/test_backtesting.py`.
    - [x] Subtask 5.2: Write a test case to verify correct initialization.
    - [x] Subtask 5.3: Write test cases for executing each type of trade (`BUY_LONG`, `SELL_SHORT`, `CLOSE_LONG`, `CLOSE_SHORT`) and verify the impact on capital, position, and P&L.
    - [x] Subtask 5.4: Write a test case to ensure brokerage costs are applied correctly.
    - [x] Subtask 5.5: Write a test case for the `reset` method.

## Dev Notes
- **File Location**: `src/backtesting/engine.py` [Source: `docs/architecture/source-tree.md#6-source-directory-src`]
- **Class**: `BacktestingEngine`
- **Responsibilities**: This class is the financial ledger of the simulation. It manages capital, tracks positions, and calculates P&L, including transaction costs. It does not interact with the data feed directly. [Source: `docs/architecture/rl-model-architecture-detailed.md#2-srcbacktestingenginepy---backtesting-engine`]

### Testing
- Unit tests should be created in a new file `tests/test_backtesting.py`. [Source: `docs/architecture/source-tree.md#1-top-level-directories`]
- Tests should be comprehensive, covering all trade types and financial calculations.

## QA Results
